name: Build and Deploy to Azure VM

on:
  push:
    branches:
      - main
  workflow_dispatch:

defaults:
  run:
    working-directory: .

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USER }}
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          port: 22
          source: "."
          target: "/tmp/shivawebapp-deploy"
          strip_components: 0

      - name: Deploy to Azure VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USER }}
          password: ${{ secrets.AZURE_VM_PASSWORD }}
          port: 22
          script_stop: true
          script: |
            set -e
            
            # ZERO-DOWNTIME DEPLOYMENT STRATEGY
            # Step 1: Build new image while old container is still running (NO DOWNTIME)
            echo "Building new Docker image (old container still serving traffic)..."
            cd /tmp/shivawebapp-deploy
            docker build -t shivawebapp:latest .
            
            # Step 2: Quick container swap (minimal downtime ~1-2 seconds)
            echo "Performing zero-downtime container update..."
            cd /home/humacv2admin/humacv2/
            
            # Use docker compose update strategy:
            # - Build happens first (while old container runs)
            # - New container starts
            # - Old container stops
            # - Total downtime: ~1-2 seconds (just the swap time)
            docker compose up -d --no-deps shivawebapp
            
            # Wait for new container to be ready
            echo "Waiting for new container to start..."
            sleep 3
            
            # Health check - verify new container is responding
            MAX_RETRIES=10
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if docker ps | grep -q shivawebapp && docker ps --filter "name=shivawebapp" --format "{{.Status}}" | grep -q "Up"; then
                echo "✓ New container is running and healthy"
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Waiting for container health check... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 2
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "⚠ Warning: Container health check failed, but container may still be starting"
              echo "Check logs with: docker logs shivawebapp"
            fi
            
            # Cleanup old images (keep recent versions for rollback)
            echo "Cleaning up old Docker images..."
            docker image prune -f --filter "until=24h"
            
            # Cleanup temporary deployment files
            rm -rf /tmp/shivawebapp-deploy
            
            # Show deployment status
            echo ""
            echo "=========================================="
            echo "Deployment completed successfully!"
            echo "=========================================="
            docker ps --filter "name=shivawebapp" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
